# Лабораторная работа - Разработка REST API и работа с OpenAPI

---

## Цель работы

Изучение принципов разработки RESTful API с использованием фреймворка FastAPI, автоматической генерации документации OpenAPI и тестирования API с помощью Swagger UI.

---

## 2. Теоретическая часть

### REST API

REST (Representational State Transfer) — это архитектурный стиль, который определяет набор ограничений для создания веб-сервисов. REST основан на шести руководящих принципах:

1. **Единообразный интерфейс (Uniform Interface)** - последовательный интерфейс для взаимодействия между клиентами и серверами
2. **Клиент-сервер (Client-Server)** - разделение ответственности между клиентом и сервером
3. **Отсутствие состояния (Stateless)** - каждый запрос содержит всю необходимую информацию
4. **Кэшируемый (Cacheable)** - ответы помечаются как кэшируемые или некэшируемые
5. **Слоистая система (Layered System)** - архитектура из иерархических слоев
6. **Код по требованию (Code on Demand)** - опциональное расширение функциональности клиента

### OpenAPI и Swagger

**OpenAPI Specification (OAS)** — стандартный интерфейс для описания RESTful API, независящий от языка программирования.

**Swagger** — набор инструментов с открытым исходным кодом для проектирования, создания и документирования REST API.

### FastAPI

FastAPI — современный, высокопроизводительный веб-фреймворк для создания API на Python 3.7+. Ключевые особенности:

- Высокая производительность (наравне с NodeJS и Go)
- Автоматическая генерация интерактивной документации
- Автоматическая валидация данных с использованием Pydantic
- Поддержка асинхронного программирования
- Основан на стандартах OpenAPI и JSON Schema

---

## Практическая часть

### Установка зависимостей

Для выполнения работы были установлены следующие пакеты:

```bash
pip install fastapi uvicorn[standard] pydantic sqlalchemy
```

### Задание 1: Создание простого REST API

Создан файл `main.py` с базовым REST API для управления библиотекой книг.

**Реализованные эндпоинты:**

- `GET /` - корневой эндпоинт
- `GET /api/books` - получение списка книг
- `GET /api/books/{book_id}` - получение книги по ID
- `POST /api/books` - создание новой книги
- `PUT /api/books/{book_id}` - полное обновление книги
- `PATCH /api/books/{book_id}` - частичное обновление книги
- `DELETE /api/books/{book_id}` - удаление книги

**Запуск приложения:**

```bash
uvicorn main:app --reload
```

Приложение доступно по адресу: `http://localhost:8000`

**Автоматическая документация:**

- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`
- OpenAPI спецификация: `http://localhost:8000/openapi.json`


После запуска приложение будет доступно по адресу http://localhost:8000.
<img width="679" height="230" alt="image" src="https://github.com/user-attachments/assets/5399b246-4844-4f2c-8d43-8b1d034baa78" />

---

#### Автоматическая документация:
Swagger UI: http://localhost:8000/docs  
<img width="1826" height="912" alt="image" src="https://github.com/user-attachments/assets/0a9d4e7e-e545-427c-8adc-b08b7d69dc4a" />  

---

ReDoc: http://localhost:8000/redoc  
<img width="1835" height="894" alt="image" src="https://github.com/user-attachments/assets/79ba03bd-af4d-44f5-a5ec-ac91136fc5fa" /> 

---

OpenAPI спецификация (JSON): http://localhost:8000/openapi.json  
<img width="1795" height="895" alt="image" src="https://github.com/user-attachments/assets/203803c1-4a6d-4714-9266-d2ce98be5ecb" />  



---

### Задание 2: Тестирование API с помощью Swagger UI

#### 1. Получение списка книг (GET /api/books)

**Запрос:** `GET /api/books`

**Результат:** Код ответа 200, возвращен список из трех книг

<img width="1756" height="672" alt="image" src="https://github.com/user-attachments/assets/0fe4c554-3706-4aed-819c-6e74cc1d3f64" />

---

#### 2. Получение книги по ID (GET /api/books/{book_id})

**Запрос:** `GET /api/books/1`

**Результат:** Код ответа 200, возвращена книга "Война и мир"

<img width="1755" height="376" alt="image" src="https://github.com/user-attachments/assets/b15f3639-844a-4cfd-9693-b50f1907d8fb" />

---

#### 3. Создание новой книги (POST /api/books)

**Запрос:** `POST /api/books`

**Тело запроса:**
```json
{
  "title": "Анна Каренина",
  "author": "Лев Толстой",
  "year": 1877,
  "isbn": "9785170654321"
}
```

**Результат:** Код ответа 201, создана новая книга с ID 4

<img width="1762" height="386" alt="image" src="https://github.com/user-attachments/assets/47cadb4d-813d-4807-ae9c-07d95842953a" />

---

#### 4. Частичное обновление книги (PATCH /api/books/{book_id})

**Запрос:** `PATCH /api/books/1`

**Тело запроса:**
```json
{
  "year": 1869
}
```

**Результат:** Код ответа 200, обновлен год издания книги

<img width="1754" height="381" alt="image" src="https://github.com/user-attachments/assets/a2617ae9-c338-4ada-9de4-c78e85dfc97a" />

---

#### 5. Удаление книги (DELETE /api/books/{book_id})

**Запрос:** `DELETE /api/books/2`

**Результат:** Код ответа 204 (No Content), книга успешно удалена

<img width="1765" height="180" alt="image" src="https://github.com/user-attachments/assets/497853ba-0589-41b0-8e22-e5a50143d2ba" />

**Проверка удаления:** `GET /api/books/2`

**Результат:** Код ответа 404, книга не найдена

<img width="1757" height="351" alt="image" src="https://github.com/user-attachments/assets/f585fe80-00b8-4afc-8b26-cdb792155f1c" />

---

#### 6. Тестирование валидации

**Запрос:** `POST /api/books` с некорректными данными

**Тело запроса:**
```json
{
  "title": "Некорректные данные",
  "author": "Некорректный год",
  "year": 3000,
  "isbn": "9785170654322"
}
```

**Результат:** Код ответа 422 (Unprocessable Entity), ошибка валидации - год превышает текущий

<img width="1762" height="562" alt="image" src="https://github.com/user-attachments/assets/cdbcdecf-3b08-4d32-9021-86c1d10cc448" />

---

### Задание 3: Изучение OpenAPI спецификации

Проанализирована автоматически сгенерированная OpenAPI спецификация:

#### Структура спецификации:

1. **Раздел `info`** - содержит метаданные API:
   - `title`: "Books API"
   - `description`: "REST API для управления библиотекой книг"
   - `version`: "1.0.0"

2. **Раздел `paths`** - описывает все эндпоинты с их параметрами, телами запросов и ответов

3. **Раздел `components/schemas`** - содержит схемы данных:
   - `Book` - модель книги
   - `BookUpdate` - модель для частичного обновления
   - `HTTPValidationError` - модель ошибки валидации

4. **Для каждого эндпоинта указаны:**
   - HTTP метод
   - Параметры (path, query, body)
   - Возможные коды ответов (200, 201, 204, 404, 422)
   - Схемы запросов и ответов

Спецификация сохранена в файл `openapi.json`.

---

### Задание 4: Расширение API

#### 4.1. Добавление фильтрации и поиска

Добавлены параметры фильтрации для эндпоинта `GET /api/books`:

- `author` - поиск по автору (частичное совпадение)
- `year_from` - минимальный год издания
- `year_to` - максимальный год издания

<img width="1817" height="852" alt="image" src="https://github.com/user-attachments/assets/c9c903af-1568-4bd5-a598-eb6640451d5e" />

**Тестирование:**

**1. Поиск по автору:** `GET /api/books?author=толстой`

**Результат:** Возвращены только книги Льва Толстого

<img width="1759" height="411" alt="image" src="https://github.com/user-attachments/assets/be4d611b-5a60-4988-838a-e20e19b8ca74" />

**2. Фильтр по годам:** `GET /api/books?year_from=1860&year_to=1870`

**Результат:** Возвращены книги, изданные в период 1860-1870 годов

<img width="1762" height="537" alt="image" src="https://github.com/user-attachments/assets/10c1f8f2-6ee9-45ed-a20b-1b758837149d" />

---

#### 4.2. Добавление пагинации

Добавлены параметры пагинации:

- `skip` - количество книг для пропуска (offset)
- `limit` - максимальное количество книг в ответе

<img width="1442" height="821" alt="image" src="https://github.com/user-attachments/assets/78f32c40-582e-4b58-8463-299014fdd11f" />

---

#### 4.3. Добавление статистики

Создан новый эндпоинт `GET /api/stats` для получения статистики:

- Общее количество книг
- Распределение по авторам
- Распределение по векам

<img width="1750" height="895" alt="image" src="https://github.com/user-attachments/assets/11d0b0a4-11af-4725-97b1-026f4d14adff" />

---

### Задание 5: Добавление базы данных SQLite

Реализована интеграция с базой данных SQLite с использованием SQLAlchemy.

**Создан файл `database.py`:**

- Настроен движок SQLAlchemy для работы с SQLite
- Создана модель `BookDB` для таблицы books
- Реализована функция `get_db()` для управления сессиями

**Модифицирован файл `main.py`:**

- Все операции CRUD теперь работают с базой данных
- Добавлена зависимость `db: Session = Depends(get_db)` ко всем эндпоинтам
- Данные сохраняются между перезапусками приложения

**Структура таблицы books:**

- `id` - первичный ключ (auto-increment)
- `title` - название книги (String 200)
- `author` - автор книги (String 100)
- `year` - год издания (Integer)
- `isbn` - ISBN книги (String 13, nullable)

---

### Задание 6: Добавление аутентификации

Реализована простая аутентификация с использованием API ключей.

**Создан файл `auth.py`:**

- Определен секретный API ключ: `secret-api-key-12345`
- Реализована функция `verify_api_key()` для проверки ключа
- При неверном ключе возвращается ошибка 403 Forbidden

**Аунтетификация**
<img width="807" height="380" alt="image" src="https://github.com/user-attachments/assets/971b855d-efe3-4dd4-96b4-0d4dfc674f6a" />


**Защищены операции изменения данных:**

- `POST /api/books` - создание книги
- `PUT /api/books/{book_id}` - полное обновление
- `PATCH /api/books/{book_id}` - частичное обновление
- `DELETE /api/books/{book_id}` - удаление

**Операции чтения остались публичными:**

- `GET /api/books` - получение списка
- `GET /api/books/{book_id}` - получение книги
- `GET /api/stats` - получение статистики

Для выполнения защищенных операций необходимо передавать заголовок:
```
X-API-Key: secret-api-key-12345
```

####  POST /api/books  
**Без аутентификации** 
<img width="1760" height="351" alt="image" src="https://github.com/user-attachments/assets/876b223a-7f4b-4bb1-83af-1f4c6e8101b2" />

**С аутентификацией**    
<img width="1758" height="384" alt="image" src="https://github.com/user-attachments/assets/fb39d8a4-b402-4f0e-a332-eba5d00f90dd" />

---

## 4. Структура проекта

```
project/
├── main.py          # Основное приложение FastAPI
├── database.py      # Настройка БД и модели SQLAlchemy
├── auth.py          # Модуль аутентификации
├── books.db         # База данных SQLite
├── openapi.json     # Спецификация OpenAPI
└── requirements.txt # Зависимости проекта
```

---

## 5. Результаты тестирования

Все эндпоинты протестированы через Swagger UI:

| Эндпоинт | Метод | Результат | Код ответа |
|----------|-------|-----------|------------|
| `/` | GET | Корневая страница | 200 |
| `/api/books` | GET | Список книг | 200 |
| `/api/books/{id}` | GET | Книга по ID | 200 / 404 |
| `/api/books` | POST | Создание книги | 201 |
| `/api/books/{id}` | PUT | Обновление книги | 200 / 404 |
| `/api/books/{id}` | PATCH | Частичное обновление | 200 / 404 |
| `/api/books/{id}` | DELETE | Удаление книги | 204 / 404 |
| `/api/stats` | GET | Статистика | 200 |

**Валидация данных работает корректно:**
- Некорректные данные отклоняются с кодом 422
- Предоставляются детальные сообщения об ошибках

**Аутентификация работает корректно:**
- Запросы без API ключа отклоняются с кодом 403
- Запросы с верным ключом выполняются успешно

---

## 6. Ответы на контрольные вопросы

### 1. Что такое REST и какие шесть принципов лежат в его основе?

REST (Representational State Transfer) - архитектурный стиль для создания веб-сервисов. Шесть принципов:
1. Единообразный интерфейс
2. Клиент-сервер
3. Отсутствие состояния
4. Кэшируемость
5. Слоистая система
6. Код по требованию (опционально)

### 2. В чем разница между методами PUT и PATCH?

- **PUT** - полное обновление ресурса, все поля должны быть указаны
- **PATCH** - частичное обновление, обновляются только переданные поля

### 3. Что означает идемпотентность HTTP метода?

Идемпотентность означает, что многократное выполнение одной операции дает тот же результат.

**Идемпотентные методы:** GET, PUT, PATCH, DELETE  
**Неидемпотентные методы:** POST

### 4. Какие коды состояния HTTP используются?

- **Успешные операции (2xx):** 200 OK, 201 Created, 204 No Content
- **Ошибки клиента (4xx):** 400 Bad Request, 401 Unauthorized, 403 Forbidden, 404 Not Found, 422 Unprocessable Entity
- **Ошибки сервера (5xx):** 500 Internal Server Error, 503 Service Unavailable

### 5. Что такое OpenAPI Specification и для чего она используется?

OpenAPI Specification (OAS) - стандартный формат описания REST API, независимый от языка. Используется для:
- Документирования API
- Автоматической генерации клиентских библиотек
- Валидации запросов/ответов
- Тестирования API

### 6. В чем разница между OpenAPI и Swagger?

- **OpenAPI** - спецификация (стандарт описания API)
- **Swagger** - набор инструментов для работы с OpenAPI (Swagger UI, Swagger Editor)

### 7. Какие преимущества дает использование FastAPI?

- Высокая производительность
- Автоматическая генерация документации
- Автоматическая валидация данных
- Поддержка асинхронности
- Минимум кода для создания API
- Отличная поддержка IDE

### 8. Что такое Pydantic и как он используется в FastAPI?

Pydantic - библиотека для валидации данных с использованием аннотаций типов Python. В FastAPI используется для:
- Определения схем данных
- Автоматической валидации входных данных
- Сериализации ответов
- Генерации JSON Schema для OpenAPI

### 9. Как FastAPI автоматически генерирует документацию API?

FastAPI анализирует:
- Аннотации типов функций
- Pydantic модели
- Декораторы маршрутов
- Docstrings функций

На основе этого автоматически создается OpenAPI спецификация и интерактивная документация.

### 10. Что такое валидация данных и почему она важна?

Валидация данных - проверка корректности входных данных согласно определенным правилам. Важна для:
- Предотвращения ошибок
- Обеспечения безопасности
- Поддержания целостности данных
- Предоставления понятных сообщений об ошибках

### 11. Объясните принцип stateless в REST API

Принцип stateless означает, что сервер не хранит состояние клиента между запросами. Каждый запрос содержит всю необходимую информацию для его обработки. Это улучшает масштабируемость и надежность.

### 12. Какие компоненты входят в структуру OpenAPI документа?

- `openapi` - версия спецификации
- `info` - метаданные API
- `servers` - список серверов
- `paths` - описание эндпоинтов
- `components` - переиспользуемые компоненты (schemas, responses, parameters)
- `security` - требования безопасности
- `tags` - теги для группировки

### 13. Как реализуется обработка ошибок в FastAPI?

Через исключение `HTTPException`:
```python
raise HTTPException(status_code=404, detail="Не найдено")
```

FastAPI автоматически возвращает корректный JSON ответ с указанным кодом и сообщением.

### 14. Что такое HATEOAS и как этот принцип применяется в REST API?

HATEOAS (Hypermedia as the Engine of Application State) - клиент взаимодействует с приложением через гиперссылки, динамически предоставляемые сервером. Клиент знает только начальный URI, остальные действия определяются из ответов сервера.

### 15. Какие методы аутентификации можно использовать в REST API?

- API ключи (X-API-Key)
- Basic Authentication
- Bearer Token
- OAuth 2.0
- JWT (JSON Web Tokens)
- Session-based authentication

---

## 7. Выводы

В ходе выполнения лабораторной работы были изучены:

1. **Принципы REST API** - архитектурный стиль, HTTP методы, коды состояния
2. **FastAPI фреймворк** - создание эндпоинтов, автоматическая документация
3. **Pydantic модели** - валидация данных, схемы
4. **OpenAPI спецификация** - структура, компоненты, использование
5. **Работа с БД** - интеграция SQLAlchemy, операции CRUD
6. **Аутентификация** - защита эндпоинтов с помощью API ключей
7. **Тестирование API** - использование Swagger UI

**Приобретенные навыки:**

- Разработка RESTful API с использованием FastAPI
- Реализация операций CRUD
- Валидация входных данных
- Работа с базами данных через ORM
- Документирование API
- Тестирование и отладка API
- Реализация базовой аутентификации

Полученные знания являются фундаментальными для разработки современных веб-приложений и микросервисов.

---


